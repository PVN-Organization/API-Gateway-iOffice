# VXP API Gateway - Send & Receive Documents

üöÄ **GitHub:** https://github.com/PVN-Organization/API-Gateway-iOffice

API Gateway trung gian th√¥ng minh ƒë·ªÉ g·ª≠i v√† nh·∫≠n vƒÉn b·∫£n qua VXP SDK.

**üéâ PRODUCTION READY - Docker Image: 93.6MB**

---

## üìö T√ÄI LI·ªÜU DUY NH·∫§T

**File n√†y ch·ª©a T·∫§T C·∫¢:**
- ‚úÖ Docker commands (build, run, deploy)
- ‚úÖ Java commands (compile, execute)
- ‚úÖ API testing (cURL examples cho 8 endpoints)
- ‚úÖ Configuration (credentials, environment variables)
- ‚úÖ Architecture (pipeline workflow, EDXML wrapping)
- ‚úÖ Troubleshooting (common issues & solutions)

**Kh√¥ng c·∫ßn file n√†o kh√°c!** T·∫•t c·∫£ commands copy & paste tr·ª±c ti·∫øp.

---

**‚ú® T√≠nh nƒÉng:**
- ‚úÖ Upload **b·∫•t k·ª≥ file format** - TXT, PDF, DOCX, XML, JSON, v.v.
- ‚úÖ **Auto EDXML Wrapping** - T·ª± ƒë·ªông ƒë√≥ng g√≥i file th√†nh EDXML ‚≠ê‚≠ê‚≠ê
- ‚úÖ **ENV Config** - Th√¥ng tin ƒë∆°n v·ªã qua bi·∫øn m√¥i tr∆∞·ªùng, kh√¥ng c·∫ßn API ‚≠ê NEW!
- ‚úÖ **Parse & Decode Content** - T·ª± ƒë·ªông decode n·ªôi dung file t·ª´ EDXML ‚≠ê NEW!
- ‚úÖ **Aggregate Mode** - G·ªôp nhi·ªÅu files ‚Üí 1 EDXML ‚≠ê NEW!
- ‚úÖ **Docker Ready** - Build & deploy v·ªõi Docker üê≥
- ‚úÖ **Production Ready** - Tested & Working v·ªõi VXP Server! üéâ
- ‚úÖ **File validation layer** - Validate tr∆∞·ªõc khi g·ª≠i VXP
- ‚úÖ **Smart error messages** - B√°o l·ªói r√µ r√†ng v·ªõi chi ti·∫øt
- ‚úÖ **Query Parameters** - Filter received documents
- ‚úÖ Send/Receive document pipeline
- ‚úÖ Auto signature cho VXP
- ‚úÖ 9 REST API endpoints
- ‚úÖ Postman collection s·∫µn

**üì¶ Files Structure:**
```
/Users/duyphuongpham/Downloads/20220209_java_SDKVXP_Example/
‚îú‚îÄ‚îÄ README.md                              üìñ T√†i li·ªáu duy nh·∫•t (THIS FILE!)
‚îú‚îÄ‚îÄ Dockerfile                             üê≥ Docker image definition
‚îú‚îÄ‚îÄ docker-compose.yml                     üê≥ Docker Compose config
‚îú‚îÄ‚îÄ .dockerignore                          üê≥ Docker build exclusions
‚îú‚îÄ‚îÄ VXP_Gateway_API.postman_collection.json üìÆ Postman collection
‚îú‚îÄ‚îÄ test_document.txt                      üìÑ Test file
‚îî‚îÄ‚îÄ JDK 1.8/SDKVXP_Example/
    ‚îú‚îÄ‚îÄ pom.xml                            Maven config
    ‚îú‚îÄ‚îÄ lib/                               VXP SDK JARs
    ‚îú‚îÄ‚îÄ resources/                         Config files
    ‚îî‚îÄ‚îÄ src/main/java/com/vpcp/
        ‚îú‚îÄ‚îÄ example/                       Original SDK examples
        ‚îî‚îÄ‚îÄ gateway/                       üéØ Gateway code (25+ files)
            ‚îú‚îÄ‚îÄ SimpleVXPApiGateway.java   HTTP Server
            ‚îú‚îÄ‚îÄ DocumentPipeline.java      Document logic + wrapping
            ‚îú‚îÄ‚îÄ AgencyPipeline.java        Agency logic
            ‚îú‚îÄ‚îÄ EdxmlBuilder.java          ‚≠ê Auto EDXML wrapper
            ‚îú‚îÄ‚îÄ EdxmlValidator.java        File validator
            ‚îú‚îÄ‚îÄ MockDocumentStore.java     Mock storage for testing
            ‚îî‚îÄ‚îÄ [Models...]                Request/Response models
```

**üéØ Gateway = Trung Gian Th√¥ng Minh:**
- ‚úÖ **Auto wrap** file TXT/PDF/DOCX ‚Üí EDXML format ‚≠ê
- ‚úÖ Validate file (size, structure, format)
- ‚úÖ Check fromCode = systemId
- ‚úÖ Parse v√† verify XML
- ‚úÖ Base64 encode file content
- ‚úÖ T·∫°o EDXML header/body/attachments t·ª± ƒë·ªông
- ‚úÖ B√°o l·ªói chi ti·∫øt n·∫øu fail

**üöÄ Workflow:**
```
User uploads TXT/PDF/DOCX
  ‚Üì
Gateway nh·∫≠n file
  ‚Üì
Gateway wrap th√†nh EDXML (auto!) ‚≠ê
  ‚Üì
VXP SDK g·ª≠i l√™n server
  ‚Üì
Success!
```

---

## üöÄ Quick Start

### Option 1: Docker (Recommended) üê≥

**‚ö†Ô∏è QUAN TR·ªåNG:** Docker commands PH·∫¢I ch·∫°y t·ª´ **project root** (th∆∞ m·ª•c c√≥ README.md):

#### 1. Build Docker Image

**Copy & paste to√†n b·ªô:**
```bash
cd /Users/duyphuongpham/Downloads/20220209_java_SDKVXP_Example
docker build -t vxp-api-gateway:latest .
```

**K·∫øt qu·∫£ mong ƒë·ª£i:**
```
‚úÖ Successfully tagged vxp-api-gateway:latest
‚úÖ Image size: ~94MB
```

#### 2. Run Container
```bash
# Run v·ªõi default settings (vxp.saas.03)
docker run -d \
  --name vxp-gateway \
  -p 8080:8080 \
  --restart unless-stopped \
  vxp-api-gateway:latest

# Check health
curl http://localhost:8080/api/health
```

#### 3. Container Management
```bash
# View logs
docker logs -f vxp-gateway

# Stop
docker stop vxp-gateway

# Start
docker start vxp-gateway

# Restart
docker restart vxp-gateway

# Remove
docker rm -f vxp-gateway
```

#### 4. Using Docker Compose
```bash
# Start all services
docker-compose up -d

# View logs
docker-compose logs -f

# Stop
docker-compose down

# Rebuild & restart
docker-compose up -d --build
```

#### 5. Environment Variables Configuration ‚≠ê NEW!

**Config th√¥ng tin ƒë∆°n v·ªã qua ENV - KH√îNG c·∫ßn truy·ªÅn meta qua API:**

```bash
docker run -d \
  --name vxp-gateway \
  -p 8080:8080 \
  -e SYSTEM_ID=vxp.saas.03 \
  -e SECRET_KEY=your-secret-key \
  -e ORG_ID=vxp.saas.03 \
  -e ORG_IN_CHARGE="ƒê∆°n v·ªã test vxp 3" \
  -e ORG_NAME="ƒê∆°n v·ªã test vxp 3" \
  -e ORG_ADDRESS="S·ªë 1, H√† N·ªôi" \
  -e ORG_EMAIL="contact@example.vn" \
  -e ORG_TELEPHONE="+84 24 1234 5678" \
  -e ORG_FAX="+84 24 8765 4321" \
  -e ORG_WEBSITE="https://example.vn" \
  --restart unless-stopped \
  vxp-api-gateway:latest
```

**L·ª£i √≠ch:**
- ‚úÖ Kh√¥ng c·∫ßn truy·ªÅn `meta.from` qua API
- ‚úÖ Gateway t·ª± ƒë·ªông s·ª≠ d·ª•ng ENV cho FROM info
- ‚úÖ API ch·ªâ c·∫ßn truy·ªÅn `to` v√† file
- ‚úÖ ƒê∆°n gi·∫£n h√≥a API calls

**V√≠ d·ª• v·ªõi docker-compose.yml:**
```yaml
# docker-compose.yml ƒë√£ c√≥ s·∫µn c·∫•u h√¨nh ƒë·∫ßy ƒë·ªß
docker-compose up -d
```

### Option 2: Direct Java (Without Docker)

**‚ö†Ô∏è Ch·∫°y t·ª´ JDK directory:**

```bash
cd "/Users/duyphuongpham/Downloads/20220209_java_SDKVXP_Example/JDK 1.8/SDKVXP_Example"

# Compile (n·∫øu ch∆∞a compile)
mvn compile

# Run Gateway
java -cp "target/classes:lib/*" \
  com.vpcp.gateway.SimpleVXPApiGateway \
  8080 \
  vxp.saas.03 \
  A7TKG/r2gOKTEpe1MhWx6zw8O4JfzN0KkCRS6HZY81Ve
```

**K·∫øt qu·∫£:**
```
‚úÖ Gateway: http://localhost:8080
‚úÖ Docker Image: 93.6MB
‚úÖ Auto EDXML Wrapping: Working
‚úÖ Mock Document Store: Working
```

### 2. Import Postman

File: `VXP_Gateway_API.postman_collection.json`

### 3. Test APIs

#### Test v·ªõi cURL

**Health Check:**
```bash
curl http://localhost:8080/api/health
```

**Get Agencies:**
```bash
# Get all agencies (111,000+)
curl http://localhost:8080/api/agencies

# Get specific agency
curl "http://localhost:8080/api/agencies?id=vxp.saas.03"
```

**Send Single Document (Auto EDXML Wrap):**
```bash
# T·∫°o test file
echo "This is a test document from VXP Gateway" > test_document.txt

# Option A: V·ªõi ENV Config (RECOMMENDED - ƒë∆°n gi·∫£n nh·∫•t!)
curl -X POST http://localhost:8080/api/documents/send \
  -F 'to=[{"organId":"vxp.saas.02"}]' \
  -F "file=@test_document.txt"

# Option B: V·ªõi meta JSON (kh√¥ng d√πng ENV)
curl -X POST http://localhost:8080/api/documents/send \
  -F 'meta={"from":{"organId":"vxp.saas.03","organizationInCharge":"ƒê∆°n v·ªã test vxp 3","organName":"ƒê∆°n v·ªã test vxp 3"},"to":[{"organId":"vxp.saas.02"}]}' \
  -F "file=@test_document.txt"

# Response:
# {
#   "success": true,
#   "message": "Document sent successfully",
#   "data": {
#     "docId": "68edb8c8c2dcb14db773ce44",
#     "fileName": "test_document.txt"
#   }
# }
```

**Send Multiple Documents (Aggregate Mode) ‚≠ê:**
```bash
# T·∫°o nhi·ªÅu test files
echo "File 1 content" > file1.txt
echo "File 2 content" > file2.txt  
echo "File 3 content" > file3.txt

# Aggregate: G·ªôp 3 files ‚Üí 1 EDXML (v·ªõi ENV config)
curl -X POST http://localhost:8080/api/documents/send/batch \
  -F 'to=[{"organId":"vxp.saas.02"}]' \
  -F "aggregate=true" \
  -F "file=@file1.txt" \
  -F "file=@file2.txt" \
  -F "file=@file3.txt"

# Response:
# {
#   "success": true,
#   "message": "Processed 3 files: 3 success, 0 failed",
#   "totalFiles": 3,
#   "successCount": 3,
#   "failCount": 0,
#   "results": [
#     {
#       "fileName": "file1.txt",
#       "success": true,
#       "docId": "68edc45bc2dcb14db773d2dd",
#       "message": "Document sent successfully (File ƒë√£ ƒë∆∞·ª£c Gateway wrap th√†nh EDXML)"
#     },
#     {
#       "fileName": "file2.txt",
#       "success": true,
#       "docId": "68edc45bc2dcb14db773d2de",
#       "message": "Document sent successfully"
#     },
#     {
#       "fileName": "file3.txt",
#       "success": true,
#       "docId": "68edc45cc2dcb14db773d2df",
#       "message": "Document sent successfully"
#     }
#   ]
# }
```

**Batch v·ªõi nhi·ªÅu file types:**
```bash
# Mix formats: TXT, PDF, DOC, JSON
curl -X POST http://localhost:8080/api/documents/send/batch \
  -F "fromCode=vxp.saas.03" \
  -F "toCode=vxp.saas.02" \
  -F "file=@document.txt" \
  -F "file=@report.pdf" \
  -F "file=@contract.doc" \
  -F "file=@data.json"
```

**Get Received Documents:**
```bash
# Get all
curl http://localhost:8080/api/documents/received

# Get v·ªõi limit
curl "http://localhost:8080/api/documents/received?limit=10"

# Get v·ªõi filters
curl "http://localhost:8080/api/documents/received?status=received&limit=5"
```

**‚ö†Ô∏è Note v·ªÅ Mock Document Store:**
- VXP Test Server kh√¥ng l∆∞u documents ‚Üí Gateway d√πng **Mock Store** (in-memory)
- Documents ch·ªâ t·ªìn t·∫°i trong **c√πng container session**
- Restart container ‚Üí Mock Store b·ªã clear
- **Production VXP Server:** S·∫Ω d√πng VXP data th·ª±c, kh√¥ng d√πng Mock

**Test received documents:**
```bash
# 1. Send document
curl -X POST http://localhost:8080/api/documents/send \
  -F "fromCode=vxp.saas.03" \
  -F "toCode=vxp.saas.03" \
  -F "file=@test_document.txt"

# 2. Query received ngay sau (trong c√πng session)
curl http://localhost:8080/api/documents/received
# ‚Üí S·∫Ω th·∫•y document v·ª´a send
```

**Get Document Detail:**
```bash
curl http://localhost:8080/api/documents/{docId}
```

**Update Document Status:**
```bash
curl -X PUT http://localhost:8080/api/documents/status \
  -H "Content-Type: application/json" \
  -d '{"docId":"your-doc-id","status":"done"}'
```

#### Test v·ªõi Postman

**Import:**
```
VXP_Gateway_API.postman_collection.json
```

**Folders:**
- üè• **Health & System** - Health check, Get agencies
- üì§ **Send Documents** - Upload files v·ªõi auto EDXML wrap
- üì• **Receive Documents** - Query received t·ª´ Mock Store
- üîÑ **COMPLETE FLOW** - Test send ‚Üí receive flow (run theo th·ª© t·ª±)

**Test Flow:**
1. Step 0: Health Check ‚úÖ
2. Step 1: Send Document (vxp.saas.03 ‚Üí vxp.saas.03) ‚úÖ
3. Step 2: Get Received (Mock Store shows document) ‚úÖ
4. Step 3-4: Detail/Status (‚ö†Ô∏è may fail - VXP test server limitation)

**Note:**
- All requests use **port 8080** (Docker/Local)
- `fromCode` & `toCode` already configured
- `toCode` parameter is **REQUIRED**
- Mock Store only persists in current session

---

## üì° API Endpoints (9 APIs Total)

### üè• Health & System

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET/HEAD | `/api/health` | Health check |

### üè¢ Agencies

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/agencies` | Get all agencies (111,000+) |
| GET | `/api/agencies?id={id}` | Get agency by ID |
| POST | `/api/agencies` | Register agency |

### üì§ Send Documents

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/documents/send` | Send **single** document |
| POST | `/api/documents/send/batch` | Send **multiple** documents ‚≠ê |

**Parameters (both endpoints):**
- `fromCode` (required) - Sender
- `toCode` (required) - Receiver
- `file` (required) - File(s) to upload

**Batch API:**
- Pass multiple `-F "file=@..."` 
- All files use same `fromCode` v√† `toCode`
- Returns array of results

### üì• Receive Documents

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/documents/received` | Get received documents |
|  | `?limit={n}` | Limit results |
|  | `?status={status}` | Filter by status |
|  | `?fromDate={date}` | Filter from date |
|  | `?toDate={date}` | Filter to date |
| GET | `/api/documents/{id}` | Get document detail |
| PUT | `/api/documents/status` | Update document status |

---

## üì§ Send Document (Upload)

### D√πng cURL

```bash
# Upload b·∫•t k·ª≥ file n√†o (TXT, PDF, DOC, DOCX...)
curl -X POST http://localhost:8080/api/documents/send \
  -F "fromCode=vxp.saas.03" \
  -F "toCode=vxp.saas.02" \
  -F "file=@path/to/your-file.pdf"
```

**C√°c lo·∫°i file ƒë∆∞·ª£c ch·∫•p nh·∫≠n:**
- ‚úÖ **B·∫•t k·ª≥ ƒë·ªãnh d·∫°ng n√†o** - PDF, DOCX, TXT, XML, JSON, v.v.
- ‚úÖ **Gateway t·ª± ƒë·ªông wrap th√†nh EDXML** - File kh√¥ng ph·∫£i XML s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông ƒë√≥ng g√≥i!
- ‚úÖ **VXP Server ch·∫•p nh·∫≠n** - EDXML structure chu·∫©n QCVN_102_2016

**Form Fields:**
- `fromCode` (required) - M√£ ƒë∆°n v·ªã g·ª≠i
- `toCode` (required) - M√£ ƒë∆°n v·ªã nh·∫≠n ‚≠ê
- `file` (required) - File c·∫ßn g·ª≠i (b·∫•t k·ª≥ format)
- `serviceType` (optional) - M·∫∑c ƒë·ªãnh "eDoc"
- `messageType` (optional) - M·∫∑c ƒë·ªãnh "edoc"

**Message Types:**
- `edoc` - VƒÉn b·∫£n m·ªõi
- `replacement` - VƒÉn b·∫£n thay th·∫ø
- `revocation` - Thu h·ªìi vƒÉn b·∫£n
- `update` - C·∫≠p nh·∫≠t vƒÉn b·∫£n

### Response

```json
{
  "success": true,
  "message": "Document sent successfully",
  "data": {
    "docId": "new-document-id-123",
    "fileName": "your-file.pdf",
    "fromCode": "vxp.saas.02",
    "timestamp": 1760373259290
  }
}
```

---

## üì• Receive Documents

### Get Received List

```bash
curl http://localhost:8080/api/documents/received
```

Response:
```json
{
  "success": true,
  "message": "Successfully retrieved documents",
  "data": {
    "total": 5,
    "documents": [
      {
        "id": "doc-id-123",
        "fromCode": "vxp.saas.02",
        "toCode": "vxp.saas.03",
        "messageType": "edoc",
        "serviceType": "eDoc"
      }
    ]
  }
}
```

### Get Document Detail

```bash
curl http://localhost:8080/api/documents/doc-id-123
```

Response:
```json
{
  "success": true,
  "message": "Document retrieved successfully",
  "data": {
    "docId": "doc-id-123",
    "data": "{...json content...}",
    "filePath": "/tmp/vxp_vxp.saas.03/doc-id-123.edxml"
  }
}
```

### Update Status

```bash
curl -X PUT http://localhost:8080/api/documents/status \
  -H "Content-Type: application/json" \
  -d '{"docId":"doc-id-123","status":"done"}'
```

**Status Values:**
- `inbox` - VƒÉn b·∫£n ƒë·∫øn
- `acceptance` - Ch·∫•p nh·∫≠n
- `rejection` - T·ª´ ch·ªëi
- `processing` - ƒêang x·ª≠ l√Ω
- `done` - Ho√†n th√†nh
- `fail` - Th·∫•t b·∫°i

---

## üîÑ Complete Workflow Example

### Scenario: vxp.saas.02 g·ª≠i file PDF cho vxp.saas.03

```bash
# 1. Sender (02) sends PDF
curl -X POST http://localhost:8080/api/documents/send \
  -F "fromCode=vxp.saas.02" \
  -F "file=@contract.pdf"

# Response: {"success":true, "data":{"docId":"abc123"}}

# 2. Receiver (03) gets inbox
curl http://localhost:8080/api/documents/received

# Response shows document from vxp.saas.02

# 3. Receiver (03) gets detail
curl http://localhost:8080/api/documents/abc123

# 4. Receiver (03) marks as done
curl -X PUT http://localhost:8080/api/documents/status \
  -H "Content-Type: application/json" \
  -d '{"docId":"abc123","status":"done"}'
```

---

## üèóÔ∏è Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SENDER          ‚îÇ
‚îÇ vxp.saas.02     ‚îÇ
‚îÇ Port 8080       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ POST /api/documents/send
         ‚îÇ (Upload file: PDF, DOCX, EDXML...)
         ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ VXP Server ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ RECEIVER        ‚îÇ
‚îÇ vxp.saas.03     ‚îÇ
‚îÇ Port 8080       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
  GET /api/documents/received
  GET /api/documents/{id}
  PUT /api/documents/status
```

---

## üß™ Testing

### Test Send

```bash
# Test script (d√πng edoc_new.edxml)
./test_send_document.sh

# Ho·∫∑c send file PDF
curl -X POST http://localhost:8080/api/documents/send \
  -F "fromCode=vxp.saas.02" \
  -F "file=@test.pdf"

# Ho·∫∑c send file DOCX  
curl -X POST http://localhost:8080/api/documents/send \
  -F "fromCode=vxp.saas.02" \
  -F "file=@document.docx"
```

### Test Receive

```bash
# Get received documents
curl http://localhost:8080/api/documents/received

# Get specific document
curl http://localhost:8080/api/documents/{docId}
```

---

## ‚öôÔ∏è Configuration

### Credentials

**vxp.saas.03 (Working - Verified ‚úÖ):**
- SystemID: `vxp.saas.03`
- Secret: `A7TKG/r2gOKTEpe1MhWx6zw8O4JfzN0KkCRS6HZY81Ve`
- Status: ‚úÖ **Tested and working** - 111,339 agencies retrieved
- Port: `8080`

**vxp.saas.02 (Need Verification):**
- SystemID: `vxp.saas.02`
- Secret: `AwyOIWljooz1hxgZsxpEBjCoj5rg9dMMsLJl0YydfZpd`
- Status: ‚ö†Ô∏è VXP Server returns FAIL (credentials c√≥ th·ªÉ ch∆∞a ƒë√∫ng)
- **Note:** C·∫ßn verify credentials v·ªõi VNPT

### Custom Configuration

Ch·∫°y v·ªõi systemId v√† secret t√πy ch·ªânh:

```bash
java -cp "target/classes:lib/*" com.vpcp.gateway.SimpleVXPApiGateway \
  [port] [systemId] [secret]

# Example:
java -cp "target/classes:lib/*" com.vpcp.gateway.SimpleVXPApiGateway \
  9000 custom.system.id custom_secret_key
```

---

## üõ†Ô∏è Management

### Start Gateways

```bash
# Both
./start_both_gateways.sh

# Ho·∫∑c ri√™ng l·∫ª
./start_sender_gateway.sh      # Port 8080 (vxp.saas.02)
# (Receiver gateway script removed; now unified on port 8080)
./start_api_gateway.sh         # Port 8080 (vxp.saas.03 default)
```

### Check Status

```bash
curl http://localhost:8080/api/health
curl http://localhost:8080/api/health
```

### View Logs

```bash
tail -f /tmp/gateway_sender.log
tail -f /tmp/gateway_receiver.log
```

### Stop Gateways

```bash
pkill -f SimpleVXPApiGateway
```

---

## üì¶ File Structure

```
/
‚îú‚îÄ‚îÄ VXP_Gateway_API.postman_collection.json  ‚Üê Postman collection
‚îú‚îÄ‚îÄ VXP_Complete_API.postman_collection.json ‚Üê VXP direct API
‚îÇ
‚îú‚îÄ‚îÄ Scripts:
‚îÇ   ‚îú‚îÄ‚îÄ start_both_gateways.sh               ‚Üê Start sender & receiver
‚îÇ   ‚îú‚îÄ‚îÄ start_sender_gateway.sh              ‚Üê Start sender (02)
‚îÇ   ‚îú‚îÄ‚îÄ start_receiver_gateway.sh            ‚Üê Start receiver (03)
‚îÇ   ‚îú‚îÄ‚îÄ test_send_document.sh                ‚Üê Test send
‚îÇ   ‚îî‚îÄ‚îÄ generate_signature.sh                ‚Üê Generate signature
‚îÇ
‚îî‚îÄ‚îÄ JDK 1.8/SDKVXP_Example/src/main/java/com/vpcp/gateway/
    ‚îú‚îÄ‚îÄ SimpleVXPApiGateway.java             ‚Üê Main HTTP server
    ‚îú‚îÄ‚îÄ AgencyPipeline.java                  ‚Üê Agency logic
    ‚îú‚îÄ‚îÄ DocumentPipeline.java                ‚Üê Document logic
    ‚îî‚îÄ‚îÄ [Models...]                          ‚Üê Request/Response models
```

---

## üìã All API Endpoints

### Common (Both Gateways)

```
GET  /api/health                    Health check
GET  /api/agencies                  Get all agencies (111,338 agencies)
GET  /api/agencies?id={id}          Get agency by ID or code
POST /api/agencies                  Register/update agency
```

### Sender Specific (Port 8080)

```
POST /api/documents/send            Send/Upload document
  Form-data:
    - fromCode: vxp.saas.02
    - file: Any file (PDF, DOCX, EDXML, etc.)
    - serviceType: eDoc (optional)
    - messageType: edoc (optional)
```

### Receiver Specific (Port 8080)

```
GET  /api/documents/received        Get received documents list
GET  /api/documents/{docId}         Get document detail
PUT  /api/documents/status          Update document status
  JSON:
    - docId: Document ID
    - status: done, processing, fail, etc.
```

---

## üéØ Use Cases

### Use Case 1: Send PDF Document

```bash
curl -X POST http://localhost:8080/api/documents/send \
  -F "fromCode=vxp.saas.02" \
  -F "file=@contract.pdf"
```

### Use Case 2: Send Word Document

```bash
curl -X POST http://localhost:8080/api/documents/send \
  -F "fromCode=vxp.saas.02" \
  -F "file=@report.docx"
```

### Use Case 3: Send EdXML

```bash
curl -X POST http://localhost:8080/api/documents/send \
  -F "fromCode=vxp.saas.02" \
  -F "file=@official_document.edxml"
```

### Use Case 4: Complete Receive Flow

```bash
# Get list
DOCS=$(curl -s http://localhost:8080/api/documents/received)

# Extract first docId
DOC_ID=$(echo $DOCS | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

# Get detail
curl http://localhost:8080/api/documents/$DOC_ID

# Mark done
curl -X PUT http://localhost:8080/api/documents/status \
  -H "Content-Type: application/json" \
  -d "{\"docId\":\"$DOC_ID\",\"status\":\"done\"}"
```

---

## üîß Pipeline Details

### Send Document Pipeline (v·ªõi Validation)

```
Step 1: Validate Input
   - Check fromCode (required)
   - Check file content (required)
   - Check file name (required)

Step 2: Save File
   - Save to /tmp/vxp_{systemId}/uploads/
   - Unique filename with timestamp

Step 3: Validate File Format ‚≠ê (Gateway x·ª≠ l√Ω!)
   - Check file exists
   - Check file size (max 50MB)
   - Validate XML structure
   - Parse and check root element
   - ‚ö†Ô∏è Warning n·∫øu kh√¥ng ph·∫£i XML
   - ‚úÖ Continue anyway (Gateway ch·∫•p nh·∫≠n m·ªçi file)

Step 4: Build VXP Request
   - Create JSON header
   - fromCode = systemId (validate)
   - Include serviceType, messageType

Step 5: Call VXP SDK
   - Auto signature generation
   - Send to VXP server

Step 6: Validate Response
   - Check SDK response
   - Parse status OK/FAIL
   - If fail: Include validation warning in error message

Step 7: Return Response
   - Success: Document ID, file info, timestamp
   - Fail: Error message + validation details
```

**Gateway l√†m nhi·ªám v·ª• validate!** ‚≠ê

### Receive Document Pipeline

```
1. Build Request
   - serviceType: eDoc
   - messageType: edoc

2. Call VXP SDK
   - Get received list

3. Transform Data
   - Convert SDK model ‚Üí API model
   - Extract fields

4. Return Response
   - Total count
   - Documents array
```

---

## üìù Sample Files

Sample files trong `JDK 1.8/SDKVXP_Example/resources/`:

```
edoc_new.edxml           - VƒÉn b·∫£n m·ªõi
edoc_replacement.edxml   - VƒÉn b·∫£n thay th·∫ø
edoc_revocation.edxml    - Thu h·ªìi
edoc_update.edxml        - C·∫≠p nh·∫≠t
```

---

## üß™ Test Results & Status

### ‚úÖ Gateway Ho·∫°t ƒê·ªông T·ªët

**Tested & Working:**
```bash
# SDK g·ªëc (ServiceTest.java)
cd "JDK 1.8/SDKVXP_Example"
java -cp "target/classes:lib/*" com.vpcp.example.ServiceTest

# K·∫øt qu·∫£:
Response Code: 200
status: OK
Desc: Thanh cong
Size: 111,339 agencies
```

**Gateway APIs Working:**
```bash
# Health check
curl http://localhost:8080/api/health
‚úÖ Success

# Get agencies (through Gateway)  
curl http://localhost:8080/api/agencies
‚úÖ 111,339 agencies retrieved
```

### üì§ Upload File Test

**Gateway File Handling:**
- ‚úÖ **Ch·∫•p nh·∫≠n M·ªåI file format** - TXT, PDF, DOCX, XML, EDXML
- ‚úÖ **File ƒë∆∞·ª£c save th√†nh c√¥ng** v√†o `/tmp/vxp_{systemId}/uploads/`
- ‚úÖ **Pipeline validate v√† save ƒë√∫ng**

**File test_document.txt:**
```bash
# Saved successfully at:
/tmp/vxp_vxp.saas.03/uploads/1760405784665_test_document.txt

# Content verified - 415 bytes
```

**VXP Server Requirements:**
- ‚ö†Ô∏è **VXP Server y√™u c·∫ßu file .edxml h·ª£p l·ªá** ƒë·ªÉ x·ª≠ l√Ω
- ‚ö†Ô∏è File kh√¥ng ƒë√∫ng format ‚Üí VXP response JSON error
- üí° **Gateway l√†m ƒë√∫ng nhi·ªám v·ª•** - Upload v√† forward ƒë·∫øn VXP
- üí° **S·ª≠ d·ª•ng file .edxml chu·∫©n** ƒë·ªÉ VXP process th√†nh c√¥ng

### üéØ Important Rules

**VXP Server Requirements:**

1. ‚úÖ **fromCode PH·∫¢I kh·ªõp v·ªõi systemId**
   ```
   ‚ùå Sai:  fromCode="002.00.20.H13" vs systemId="vxp.saas.03"
   ‚úÖ ƒê√∫ng: fromCode="vxp.saas.03"  vs systemId="vxp.saas.03"
   ```
   
2. ‚úÖ **File .edxml ph·∫£i h·ª£p l·ªá**
   - D√πng file m·∫´u trong `resources/`
   - Ho·∫∑c build EdXML ƒë√∫ng chu·∫©n
   
3. ‚úÖ **Gateway ch·∫•p nh·∫≠n m·ªçi file** (TXT, PDF, v.v.)
   - Gateway upload v√† save th√†nh c√¥ng
   - VXP Server s·∫Ω validate v√† c√≥ th·ªÉ reject

**Error t·ª´ SDK Test:**
```
ErrorDesc: "Don vi gui 002.00.20.H13 khong dung voi ma da dang ky: vxp.saas.03"
```

**‚Üí Solution: fromCode = systemId**

---

## üêõ Troubleshooting

### L·ªói: Connection refused

**Gi·∫£i ph√°p:** Start gateways
```bash
./start_both_gateways.sh
```

### L·ªói: Port already in use

**Gi·∫£i ph√°p:** Kill process c≈©
```bash
pkill -f SimpleVXPApiGateway
./start_both_gateways.sh
```

### Check Logs

```bash
# Sender log
tail -f /tmp/gateway_sender.log

# Receiver log
tail -f /tmp/gateway_receiver.log
```

### Test Connectivity

```bash
# Test sender
curl http://localhost:8080/api/health

# Test receiver
curl http://localhost:8080/api/health
```

---

## üíª Development

### Code Structure

```
SimpleVXPApiGateway.java
  ‚îú‚îÄ‚îÄ MainHandler (routing)
  ‚îú‚îÄ‚îÄ AgencyPipeline
  ‚îÇ   ‚îú‚îÄ‚îÄ getAllAgencies()
  ‚îÇ   ‚îú‚îÄ‚îÄ getAgencyById()
  ‚îÇ   ‚îî‚îÄ‚îÄ registerAgency()
  ‚îî‚îÄ‚îÄ DocumentPipeline
      ‚îú‚îÄ‚îÄ sendDocument()           ‚≠ê
      ‚îú‚îÄ‚îÄ getReceivedDocuments()   ‚≠ê
      ‚îú‚îÄ‚îÄ getDocumentDetail()      ‚≠ê
      ‚îî‚îÄ‚îÄ updateDocumentStatus()   ‚≠ê
```

### Th√™m Endpoint M·ªõi

1. Th√™m method trong Pipeline
2. Th√™m routing trong MainHandler.handle()
3. Compile: `mvn compile`
4. Restart gateway

---

## üìû Support

**Files:**
- `VXP_Gateway_API.postman_collection.json` - Postman collection
- `start_both_gateways.sh` - Start script
- `test_send_document.sh` - Test script

**Logs:**
- `/tmp/gateway_sender.log` - Sender logs
- `/tmp/gateway_receiver.log` - Receiver logs

---

## üéâ Summary

**ƒê√£ C√≥:**
- ‚úÖ 2 API Gateways (sender & receiver)
- ‚úÖ 8 REST API endpoints
- ‚úÖ Send document pipeline (upload b·∫•t k·ª≥ file)
- ‚úÖ Receive document pipeline
- ‚úÖ Auto signature handling
- ‚úÖ Postman collection v·ªõi flow s·∫µn
- ‚úÖ Kh√¥ng ch·∫°m code SDK g·ªëc

**Start:**
```bash
./start_both_gateways.sh
```

**Test:**
```
Import Postman ‚Üí Run "COMPLETE FLOW"
```

---

**Version:** 2.0  
**Updated:** 13/10/2025  
**License:** VNPT_IT

